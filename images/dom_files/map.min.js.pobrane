var datacontainer,map,edgetest,gmap_settings={gmap_zoom:7,gmap_center:{lat:52.066939,lng:19.339754},drag:null},dzialka={dz:[],border:[],multipoly:[],multipow:[]},shift=!1;function fromLatLngToPoint(t,e){var a=e.getProjection().fromLatLngToPoint(e.getBounds().getNorthEast()),o=e.getProjection().fromLatLngToPoint(e.getBounds().getSouthWest()),n=Math.pow(2,e.getZoom()),i=e.getProjection().fromLatLngToPoint(t);return new google.maps.Point((i.x-o.x)*n,(i.y-a.y)*n)}var pixelToLatlng=function(t,e){var a=map.getBounds().getNorthEast(),o=map.getBounds().getSouthWest(),n=map.getProjection(),i=n.fromLatLngToPoint(a),g=n.fromLatLngToPoint(o),s=1<<map.getZoom();return n.fromPointToLatLng(new google.maps.Point(t/s+g.x,e/s+i.y))};function pozycja(){if(gmap_settings.svgpos){var t=fromLatLngToPoint(gmap_settings.svgpos,map);newx=Math.min($mapcontainer.width()-$(".svg")[0].getBoundingClientRect().width,t.x),newx=Math.max(0,newx),newy=Math.min($mapcontainer.height()-$(".svg")[0].getBoundingClientRect().height,t.y),newy=Math.max(0,newy),$(".svg").css({top:newy,left:newx})}}function get_scale(){var t=map?map.getZoom():2,e=map?parseFloat(map.getCenter().lat()):gmap_settings.gmap_center;if(t<14)return.02;var a=156543.03392*Math.cos(e*Math.PI/180)/Math.pow(2,t);return Math.round(1/a/7.524755574*100)/100}function znajdz_punkty(){var t=$(".direction_N")[0].getBoundingClientRect(),e=$(".direction_S")[0].getBoundingClientRect(),a=$(".svgrotate").data("angle"),o=$mapcontainer[0].getBoundingClientRect().left,n=$mapcontainer[0].getBoundingClientRect().top;if(a<0&&(a+=360),a>360&&(a-=360),a>=0&&a<90)var i=[t.left-o,t.top-n],g=[t.right-o,t.bottom-n],s=[e.left-o,e.top-n],l=[e.right-o,e.bottom-n];if(a>=90&&a<180)i=[t.right-o,t.top-n],g=[t.left-o,t.bottom-n],s=[e.right-o,e.top-n],l=[e.left-o,e.bottom-n];if(a>=180&&a<270)i=[t.right-o,t.bottom-n],g=[t.left-o,t.top-n],s=[e.right-o,e.bottom-n],l=[e.left-o,e.top-n];if(a>=270&&a<360)i=[t.left-o,t.bottom-n],g=[t.right-o,t.top-n],s=[e.left-o,e.bottom-n],l=[e.right-o,e.top-n];return out={NW:i,NE:g,SW:s,SE:l},out}function sprawdz_kolizje(){if(!dzialka.multipoly)return!1;var t=znajdz_punkty(),o=[];edgetest={n:0,s:0,w:0,e:0};var i={n:[t.NW,t.NE],s:[t.SW,t.SE],w:[t.NW,t.SW],e:[t.NE,t.SE]},g=[];for(n in dzialka.multipoly){o[n]=[];for(var s=0;s<dzialka.multipoly[n].length-1;s++){var m=fromLatLngToPoint(new google.maps.LatLng(dzialka.multipoly[n][s].lat,dzialka.multipoly[n][s].lng),map);o[n].push([m.x,m.y]);var c=dzialka.multipoly[n][s],u=dzialka.multipoly[n][s+1];c.lat>=u.lat?g.push({lat1:c.lat,lng1:c.lng,lat2:u.lat,lng2:u.lng}):g.push({lat1:u.lat,lng1:u.lng,lat2:c.lat,lng2:c.lng})}}for(p in t)for(r in o){(k=inside(t[p],o[r]))||("NE"==p&&(edgetest.n+=1,edgetest.e+=1),"NW"==p&&(edgetest.n+=1,edgetest.w+=1),"SE"==p&&(edgetest.s+=1,edgetest.e+=1),"SW"==p&&(edgetest.s+=1,edgetest.w+=1))}for(e in edgetest)edgetest[e]=edgetest[e]-2*dzialka.multipoly.length+2;var f=[];for(a in g){var h=g[a].lat1+"|"+g[a].lat2+"|"+g[a].lng1+"|"+g[a].lng2;f[h]?f[h].count++:f[h]={count:0,lat1:g[a].lat1,lat2:g[a].lat2,lng1:g[a].lng1,lng2:g[a].lng2}}for(a in f)f[a].count>0&&delete f[a];for(l in i)for(d in f){var v=new google.maps.LatLng(f[d].lat1,f[d].lng1),w=new google.maps.LatLng(f[d].lat2,f[d].lng2),y=fromLatLngToPoint(v,map),z=fromLatLngToPoint(w,map),k=intersects(i[l][0][0],i[l][0][1],i[l][1][0],i[l][1][1],y.x,y.y,z.x,z.y);edgetest[l]+=.5*k}var _=Object.values(edgetest),L=Math.max.apply(null,_),b=Math.min.apply(null,_);if(3==L&&2==b){for(e in edgetest)3==edgetest[e]&&(edgetest[e]=0);_=Object.values(edgetest),L=Math.max.apply(null,_),b=Math.min.apply(null,_)}var M=0;for(e in edgetest){var T={color:"green",width:"1.6%"};edgetest[e]==L&&L>0&&(T={color:"red",width:"2.1%"}),$(".direction_"+e.toUpperCase()).css({stroke:T.color,"stroke-width":T.width,"stroke-linecap":"round"}),M+=edgetest[e]}0==M?$(".info .fit span").html(""):$(".info .fit span").html("Uwaga! "+$(".info .fit").data("name")+" w obecnym ułożeniu nie mieści w granicach "+(dzialka.multi?"działek.":"działki.")).addClass("alert")}function intersects(t,e,a,o,n,i,g,s){var l,r,p;return 0!==(l=(a-t)*(s-i)-(g-n)*(o-e))&&(r=((e-o)*(g-t)+(a-t)*(s-e))/l,0<(p=((s-i)*(g-t)+(n-g)*(s-e))/l)&&p<1&&0<r&&r<1)}function inside(t,e){if(!t)return!1;for(var a=t[0],o=t[1],n=!1,i=0,g=e.length-1;i<e.length;g=i++){var s=e[i][0],l=e[i][1],r=e[g][0],p=e[g][1];l>o!=p>o&&a<(r-s)*(o-l)/(p-l)+s&&(n=!n)}return n}function rotateanim(t,e,a){t.data("angle",a),$({deg:e}).animate({deg:a},{duration:250,step:function(e){t.css({transform:"rotate("+e+"deg)"})},complete:function(){sprawdz_kolizje()}})}function rotatestep(t){(t+=$(".svgrotate").data("angle"))>360&&(t-=360),t<0&&(t+=360),$(".svgrotate").css("transform","rotate("+t+"deg)").data("angle",t),sprawdz_kolizje()}function woj(t){return{2:"dolnośląskie",4:"kujawsko-pomorskie",6:"lubelskie",8:"lubuskie",10:"łódzkie",12:"małopolskie",14:"mazowieckie",16:"opolskie",18:"podkarpackie",20:"podlaskie",22:"pomorskie",24:"śląskie",26:"świętokrzyskie",28:"warmińsko-mazurskie",30:"wielkopolskie",32:"zachodniopomorskie"}[t=parseInt(t)]}function importmap(t,e){$.ajax({type:"post",dataType:"json",url:"/geo/service.php",data:{lat:t,lng:e},beforeSend:function(){$(".mapcontainer").append('<div class="loading"></div>'),$(".mapcontainer .loading").delay(400).fadeIn(600)},complete:function(){$(".mapcontainer .loading").remove()},success:function(t){if(datacontainer=t,"ok"==t.status){var e=new google.maps.LatLngBounds(new google.maps.LatLng(t.maxbbox[0].lat,t.maxbbox[0].lng),new google.maps.LatLng(t.maxbbox[1].lat,t.maxbbox[1].lng));map.panToBounds(e),map.fitBounds(e);var a=new google.maps.Polygon({paths:t.poly,strokeColor:"#ffffff",strokeOpacity:.9,strokeWeight:3,fillColor:"green",fillOpacity:.35,clickable:!1,zIndex:1});dzialka.dz.push(a),dzialka.multipoly.push(t.poly);for(var o=[],n=0;n<t.poly.length-1;n++){points=[{lat:t.poly[n].lat,lng:t.poly[n].lng},{lat:t.poly[n+1].lat,lng:t.poly[n+1].lng}];var i=new google.maps.Polyline({path:points,angle:t.poly[n].a,strokeColor:"#FFBBAA",strokeOpacity:0,strokeWeight:30,zIndex:2});i.addListener("click",function(){var t=$(".svgrotate").data("angle");t>360&&(t-=360),t<0&&(t+=360);var e=90*(Math.ceil((t-this.angle)/90)-(Math.ceil((t-this.angle)/90)-(t-this.angle)/90>.5?1:0))+this.angle;rotateanim($(".svgrotate"),t,e)}),i.setMap(map),o.push(i)}if(dzialka.border.push(o),shift)dzialka.multipow+=datacontainer.pow,dzialka.multi=!0;else{for(var g=0;g<dzialka.dz.length-1;g++)for(n in dzialka.dz[g].setMap(null),dzialka.border[g])dzialka.border[g][n].setMap(null);dzialka.border=dzialka.border.slice(-1),dzialka.dz=dzialka.dz.slice(-1),dzialka.multipoly=dzialka.multipoly.slice(-1),dzialka.multipow=datacontainer.pow,dzialka.multi=!1}dzialka.dz[dzialka.dz.length-1].setMap(map),(parseFloat($(".svgrotate svg").attr("width"))>parseFloat($(".svgrotate svg").attr("height"))?"h":"v")!=t.layout&&(t.angle=t.angle+90),$(".svgrotate").css("transform","rotate("+t.angle+"deg)").data("angle",t.angle);fromLatLngToPoint(new google.maps.LatLng(t.center.lat,t.center.lng),map);$(".svg").css({left:($mapcontainer.width()-$(".svg")[0].getBoundingClientRect().width)/2,top:($mapcontainer.height()-$(".svg")[0].getBoundingClientRect().height)/2}),gmap_settings.gmap_center=t.center,gmap_settings.svgpos=pixelToLatlng(parseFloat($(".svg").css("left")),parseFloat($(".svg").css("top"))),sprawdz_kolizje(),$(".info .data").html("<strong>Informacje o wybranej działce:</strong><br>Województwo: "+woj(datacontainer.wojewodztwo)+"<br>Gmina: "+datacontainer.gmina+"<br>Powiat: "+datacontainer.powiat+"<br>Powierzchnia: "+(dzialka.multi?Math.round(dzialka.multipow):datacontainer.pow)+"&nbsp;ar<br>Numer działki: "+(dzialka.multi?"(wybór wielokrotny)":datacontainer.nr)+"<br>Identyfikator: "+(dzialka.multi?"(wybór wielokrotny)":datacontainer.id)+"<br>")}}})}function initMap(){(map=new google.maps.Map(document.getElementById("map"),{zoom:gmap_settings.gmap_zoom,center:gmap_settings.gmap_center,disableDefaultUI:!0,draggable:!0,zoomControl:!0,scrollwheel:!0,tilt:0,mapTypeId:"satellite",zoomControl:!0,gestureHandling:"greedy",zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.RIGHT_BOTTOM,mapTypeIds:["roadmap","OSM","satellite"]}})).mapTypes.set("OSM",new google.maps.ImageMapType({getTileUrl:function(t,e){var a=1<<e,o=t.x%a;return o<0&&(o=a+o),"http://tile.openstreetmap.org/"+e+"/"+o+"/"+t.y+".png"},tileSize:new google.maps.Size(256,256),name:"OpenStreetMap",maxZoom:18}));map.setOptions({styles:[{featureType:"poi",stylers:[{visibility:"off"}]}]});var t=new google.maps.LatLngBounds(new google.maps.LatLng(49.002254,14.123111),new google.maps.LatLng(54.835823,24.147958));map.fitBounds(t),map.addListener("zoom_changed",function(){gmap_settings.gmap_zoom=map.getZoom(),gmap_settings.gmap_zoom>16?map.setMapTypeId(google.maps.MapTypeId.SATELLITE):gmap_settings.gmap_zoom>12?map.setMapTypeId("OSM"):map.setMapTypeId(google.maps.MapTypeId.ROADMAP),gmap_settings.gmap_zoom<13?$("#mapoverlayer").css("display","none"):$("#mapoverlayer").css("display","block"),$(".svg").css("transform","scale("+get_scale()+")"),pozycja()});var e=document.getElementById("searchmap"),a=new google.maps.places.Autocomplete(e,{types:["(cities)"],componentRestrictions:{country:"pl"}});a.bindTo("bounds",map);var o,n=new google.maps.Marker({map:map,anchorPoint:new google.maps.Point(0,-29)});a.addListener("place_changed",function(){var t=a.getPlace();t.geometry.viewport&&map.fitBounds(t.geometry.viewport),n.setPosition(t.geometry.location),n.setVisible(!0);var e={url:t.icon,size:new google.maps.Size(71,71),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(17,34),scaledSize:new google.maps.Size(25,25)};n.setIcon(e)}),map.addListener("center_changed",function(t){pozycja()}),google.maps.event.addListener(map,"click",function(t){var e=t.latLng.lat(),a=t.latLng.lng();o=setTimeout(function(){importmap(e,a)},200)}),google.maps.event.addListener(map,"dblclick",function(t){clearTimeout(o)})}$(document).ready(function(){var t;$(".svg").css("transform","scale("+get_scale()+")"),$mapcontainer=$(".mapcontainer"),$(document.body).on("mousemove",function(t){if(gmap_settings.drag)if(1==gmap_settings.drag.which){var e=$(".svgrotate").data("angle"),a=t.pageX-gmap_settings.drag.start_left,o=t.pageY-gmap_settings.drag.start_top;a=Math.min(a,$mapcontainer.width()+$mapcontainer.offset().left-$(".svg")[0].getBoundingClientRect().width),o=Math.min(o,$mapcontainer.height()+$mapcontainer.offset().top-$(".svg")[0].getBoundingClientRect().height),a=Math.max(a,$mapcontainer.offset().left),o=Math.max(o,$mapcontainer.offset().top),$(".svg").offset({left:a,top:o}),gmap_settings.svgpos=pixelToLatlng(parseFloat($(".svg").css("left")),parseFloat($(".svg").css("top"))),sprawdz_kolizje()}else if(3==gmap_settings.drag.which){var n=180/Math.PI,i=(t.pageX-$(".svg")[0].getBoundingClientRect().width/2-$(".svg").offset().left)/2,g=(t.pageY-$(".svg")[0].getBoundingClientRect().height/2-$(".svg").offset().top)/2,s=(gmap_settings.drag.start_left-$(".svg")[0].getBoundingClientRect().width/2)/2,l=(gmap_settings.drag.start_top-$(".svg")[0].getBoundingClientRect().height/2)/2,r=(e=parseInt(0|$(".svgrotate").data("angle")),n*Math.atan2(g,i)-n*Math.atan2(l,s)+e);r>360&&(r-=360),r<0&&(r+=360),$(".svgrotate").css("transform","rotate("+r+"deg)"),gmap_settings.drag.angle=r}}),$(document.body).on("mousedown",".svgrotate",function(t){gmap_settings.drag=[],gmap_settings.drag.start_top=t.pageY-$(".svg").offset().top,gmap_settings.drag.start_left=t.pageX-$(".svg").offset().left,gmap_settings.drag.which=t.which}),$(document.body).on("mouseup",function(t){gmap_settings.drag&&($(".svgrotate").data("angle",gmap_settings.drag.angle),sprawdz_kolizje()),gmap_settings.drag=null}),$(document.body).on("wheel mousewheel DOMMouseScroll",".svgrotate",function(t){t.preventDefault(),t.stopPropagation()}),$("#mapoverlayer").on("contextmenu",function(t){return t.preventDefault(),!1}),$(".rotateholder>div").on("mousedown",function(e){var a=$(".svgrotate").data("angle");a>360&&(a-=360),a<0&&(a+=360),$(this).is(".left90")&&rotateanim($(".svgrotate"),a,a-90),$(this).is(".right90")&&rotateanim($(".svgrotate"),a,a+90),$(this).is(".left-free")&&(t=setInterval(function(){rotatestep(-1)},30)),$(this).is(".right-free")&&(t=setInterval(function(){rotatestep(1)},30))}).on("mouseup mouseleave",function(){clearInterval(t)}),$(document).on("keyup keydown",function(t){shift=t.shiftKey})});